// Prisma schema for BSIM Admin Interface
// This uses the same database as the main backend

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String       @id @default(uuid())
  email       String       @unique
  password    String
  firstName   String
  lastName    String
  // FI User Reference Number - unique identifier for Open Banking
  fiUserRef   String       @unique @default(uuid()) @map("fi_user_ref")
  // Customer Information File (CIF) fields
  phone       String?
  address     String?
  city        String?
  state       String?
  postalCode  String?
  country     String?      @default("Canada")
  dateOfBirth DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  accounts    Account[]
  passkeys    Passkey[]
  creditCards CreditCard[]
  consents    Consent[]

  @@map("users")
}

model Account {
  id            String        @id @default(uuid())
  accountNumber String        @unique
  accountType   AccountType   @default(CHECKING) @map("account_type")
  balance       Decimal       @default(0) @db.Decimal(15, 2)
  userId        String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  transactions  Transaction[]

  @@map("accounts")
}

model Transaction {
  id           String          @id @default(uuid())
  type         TransactionType
  amount       Decimal         @db.Decimal(15, 2)
  balanceAfter Decimal         @db.Decimal(15, 2)
  description  String?
  accountId    String
  account      Account         @relation(fields: [accountId], references: [id], onDelete: Cascade)
  createdAt    DateTime        @default(now())

  @@map("transactions")
}

model Passkey {
  id                String   @id @default(uuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  credentialId      String   @unique
  credentialPublicKey Bytes
  counter           BigInt
  deviceType        String
  backedUp          Boolean
  transports        String[]
  createdAt         DateTime @default(now())
  lastUsedAt        DateTime?

  @@map("passkeys")
}

model CreditCard {
  id              String               @id @default(uuid())
  cardNumber      String               @unique
  cardType        CreditCardType       @default(VISA) @map("card_type")
  cardHolder      String
  expiryMonth     Int
  expiryYear      Int
  cvv             String
  creditLimit     Decimal              @db.Decimal(15, 2)
  availableCredit Decimal              @db.Decimal(15, 2)
  userId          String
  user            User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  transactions    CreditCardTransaction[]

  @@map("credit_cards")
}

model CreditCardTransaction {
  id           String                     @id @default(uuid())
  type         CreditCardTransactionType
  amount       Decimal                    @db.Decimal(15, 2)
  availableAfter Decimal                  @db.Decimal(15, 2)
  description  String?
  creditCardId String
  creditCard   CreditCard                 @relation(fields: [creditCardId], references: [id], onDelete: Cascade)
  createdAt    DateTime                   @default(now())

  @@map("credit_card_transactions")
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  TRANSFER
}

enum AccountType {
  CHECKING
  SAVINGS
  MONEY_MARKET
  CERTIFICATE_OF_DEPOSIT
}

enum CreditCardTransactionType {
  CHARGE
  PAYMENT
  REFUND
}

enum CreditCardType {
  VISA
  VISA_DEBIT
  MC
  MC_DEBIT
  AMEX
}

// Admin-specific models (separate from end users)
model AdminUser {
  id          String         @id @default(uuid())
  email       String         @unique
  firstName   String
  lastName    String
  role        AdminRole      @default(ADMIN)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  passkeys    AdminPasskey[]

  @@map("admin_users")
}

model AdminPasskey {
  id                  String    @id @default(uuid())
  adminUserId         String
  adminUser           AdminUser @relation(fields: [adminUserId], references: [id], onDelete: Cascade)
  credentialId        String    @unique
  credentialPublicKey Bytes
  counter             BigInt
  deviceType          String
  backedUp            Boolean
  transports          String[]
  createdAt           DateTime  @default(now())
  lastUsedAt          DateTime?

  @@map("admin_passkeys")
}

enum AdminRole {
  ADMIN
  SUPER_ADMIN
}

model SiteSettings {
  id        String   @id @default("default")
  logoUrl   String?
  siteName  String   @default("BSIM")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("site_settings")
}

// Configurable Credit Card Types
model CreditCardTypeConfig {
  id              String   @id @default(uuid())
  code            String   @unique  // e.g., "VISA", "MC", "AMEX"
  name            String            // Display name, e.g., "VISA", "Mastercard"
  cardNumberPrefix String           // e.g., "4" for Visa, "51-55" for MC, "34,37" for AMEX
  cardNumberLength Int     @default(16)  // 16 for most, 15 for AMEX
  cvvLength       Int     @default(3)    // 3 for most, 4 for AMEX
  isDebit         Boolean @default(false)
  isActive        Boolean @default(true)
  sortOrder       Int     @default(0)    // For display ordering
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("credit_card_type_configs")
}

// ============================================
// Open Banking / OAuth 2.0 / OIDC Models
// ============================================

// OAuth 2.0 / OIDC Clients (Third-party applications)
model OAuthClient {
  id            String    @id @default(uuid())
  clientId      String    @unique
  clientSecret            String    // plaintext (oidc-provider does direct comparison)
  clientName    String
  redirectUris  String[]  // Array of allowed redirect URIs
  postLogoutRedirectUris  String[]  @default([]) // For RP-Initiated Logout
  grantTypes    String[]  @default(["authorization_code"])
  responseTypes String[]  @default(["code"])
  scope         String    // Space-separated allowed scopes
  logoUri       String?
  policyUri     String?
  tosUri        String?
  contacts      String[]
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  consents      Consent[]

  @@map("oauth_clients")
}

// User consents for third-party access
model Consent {
  id            String      @id @default(uuid())
  grantId       String      @unique // Used by oidc-provider
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  clientId      String
  client        OAuthClient @relation(fields: [clientId], references: [clientId], onDelete: Cascade)
  scopes        String[]    // Granted scopes
  accountIds    String[]    // Specific accounts user consented to share
  expiresAt     DateTime?   // Consent expiration
  revokedAt     DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@map("consents")
}

// OIDC Provider storage for tokens, sessions, etc.
model OidcPayload {
  id            String    @id
  type          String    // 'Session', 'AccessToken', 'AuthorizationCode', etc.
  payload       Json
  grantId       String?
  userCode      String?
  uid           String?
  expiresAt     DateTime?
  consumedAt    DateTime?
  createdAt     DateTime  @default(now())

  @@index([grantId])
  @@index([userCode])
  @@index([uid])
  @@map("oidc_payloads")
}
