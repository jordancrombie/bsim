# Docker Compose override for local development
# Uses *-dev.banksim.ca subdomain pattern (compatible with *.banksim.ca wildcard cert)
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.dev.yml up --build
#
# Required DNS/hosts entries:
#   127.0.0.1 dev.banksim.ca
#   127.0.0.1 admin-dev.banksim.ca
#   127.0.0.1 auth-dev.banksim.ca
#   127.0.0.1 openbanking-dev.banksim.ca
#   127.0.0.1 ssim-dev.banksim.ca
#   127.0.0.1 payment-dev.banksim.ca
#   127.0.0.1 wsim-dev.banksim.ca
#   127.0.0.1 wsim-auth-dev.banksim.ca

services:
  # Backend API - dev domain configuration
  backend:
    environment:
      DOMAIN: dev.banksim.ca
      CORS_ORIGIN: https://localhost,https://dev.banksim.ca,https://admin-dev.banksim.ca,https://auth-dev.banksim.ca,https://openbanking-dev.banksim.ca,https://ssim-dev.banksim.ca,http://frontend:3000
      RP_ID: dev.banksim.ca
      ORIGIN: https://dev.banksim.ca

  # Frontend - dev domain configuration
  frontend:
    build:
      args:
        NEXT_PUBLIC_API_URL: https://dev.banksim.ca/api
        NEXT_PUBLIC_DOMAIN: dev.banksim.ca
        NEXT_PUBLIC_BACKEND_PORT: 443

  # Admin Interface - dev domain configuration
  admin:
    environment:
      # Use parent domain for cross-subdomain passkey sharing (admin-dev + auth-dev)
      RP_ID: banksim.ca
      ADMIN_ORIGIN: https://admin-dev.banksim.ca

  # Authorization Server - dev domain configuration
  auth-server:
    environment:
      ISSUER: https://auth-dev.banksim.ca
      CORS_ORIGIN: https://dev.banksim.ca,https://auth-dev.banksim.ca,https://openbanking-dev.banksim.ca,http://localhost:3005,https://ssim-dev.banksim.ca
      OPENBANKING_AUDIENCE: https://openbanking-dev.banksim.ca
      # Use parent domain for cross-subdomain passkey sharing (admin-dev + auth-dev)
      RP_ID: banksim.ca
      AUTH_ORIGIN: https://auth-dev.banksim.ca

  # Open Banking - dev domain configuration
  openbanking:
    environment:
      AUTH_SERVER_ISSUER: https://auth-dev.banksim.ca
      AUDIENCE: https://openbanking-dev.banksim.ca

  # WSIM Backend - dev domain configuration
  wsim-backend:
    environment:
      NODE_ENV: development
      APP_URL: https://wsim-dev.banksim.ca
      FRONTEND_URL: https://wsim-dev.banksim.ca
      AUTH_SERVER_URL: https://wsim-auth-dev.banksim.ca
      CORS_ORIGINS: https://wsim-dev.banksim.ca,https://wsim-auth-dev.banksim.ca,https://ssim-dev.banksim.ca,https://dev.banksim.ca
      BSIM_PROVIDERS: '[{"bsimId":"bsim","name":"Bank Simulator","issuer":"https://auth-dev.banksim.ca","apiUrl":"https://dev.banksim.ca","clientId":"wsim-wallet","clientSecret":"wsim-dev-secret"}]'
      # WebAuthn - allow both frontend and auth-server popup origins
      WEBAUTHN_ORIGINS: https://wsim-dev.banksim.ca,https://wsim-auth-dev.banksim.ca

  # WSIM Auth Server - dev domain configuration
  wsim-auth-server:
    environment:
      NODE_ENV: development
      ISSUER: https://wsim-auth-dev.banksim.ca
      FRONTEND_URL: https://wsim-dev.banksim.ca
      CORS_ORIGINS: https://wsim-dev.banksim.ca,https://ssim-dev.banksim.ca
      # WebAuthn - allow both frontend and auth-server popup origins
      WEBAUTHN_ORIGINS: https://wsim-dev.banksim.ca,https://wsim-auth-dev.banksim.ca
      # Popup/Embed origins for dev
      ALLOWED_POPUP_ORIGINS: https://ssim-dev.banksim.ca
      ALLOWED_EMBED_ORIGINS: https://ssim-dev.banksim.ca

  # WSIM Frontend - dev domain configuration
  wsim-frontend:
    build:
      args:
        NEXT_PUBLIC_API_URL: https://wsim-dev.banksim.ca
        NEXT_PUBLIC_AUTH_URL: https://wsim-auth-dev.banksim.ca

  # Nginx - use dev configuration
  nginx:
    volumes:
      - ./nginx/nginx.dev.conf:/etc/nginx/nginx.conf:ro
      - ./certs:/etc/nginx/certs:ro
