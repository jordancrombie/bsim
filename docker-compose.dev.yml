# Docker Compose override for local development
# Uses *-dev.banksim.ca subdomain pattern (compatible with *.banksim.ca wildcard cert)
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.dev.yml up --build
#
# Required DNS/hosts entries:
#   127.0.0.1 dev.banksim.ca
#   127.0.0.1 admin-dev.banksim.ca
#   127.0.0.1 auth-dev.banksim.ca
#   127.0.0.1 openbanking-dev.banksim.ca
#   127.0.0.1 ssim-dev.banksim.ca
#   127.0.0.1 payment-dev.banksim.ca
#   127.0.0.1 wsim-dev.banksim.ca
#   127.0.0.1 wsim-auth-dev.banksim.ca
#   127.0.0.1 transfersim-dev.banksim.ca

services:
  # Backend API - dev domain configuration
  backend:
    environment:
      DOMAIN: dev.banksim.ca
      CORS_ORIGIN: https://localhost,https://dev.banksim.ca,https://admin-dev.banksim.ca,https://auth-dev.banksim.ca,https://openbanking-dev.banksim.ca,https://ssim-dev.banksim.ca,https://wsim-dev.banksim.ca,https://wsim-auth-dev.banksim.ca,https://transfersim-dev.banksim.ca,http://frontend:3000
      RP_ID: dev.banksim.ca
      ORIGIN: https://dev.banksim.ca
      # WSIM Embedded Enrollment - dev configuration
      WSIM_AUTH_URL: https://wsim-auth-dev.banksim.ca
      # TransferSim P2P Integration
      TRANSFERSIM_API_KEY: transfersim-dev-api-key-2024

  # Frontend - dev domain configuration
  frontend:
    build:
      args:
        NEXT_PUBLIC_API_URL: https://dev.banksim.ca/api
        NEXT_PUBLIC_DOMAIN: dev.banksim.ca
        NEXT_PUBLIC_BACKEND_PORT: 443
        NEXT_PUBLIC_WSIM_AUTH_URL: https://wsim-auth-dev.banksim.ca

  # Admin Interface - dev domain configuration
  admin:
    environment:
      # Use parent domain for cross-subdomain passkey sharing (admin-dev + auth-dev)
      RP_ID: banksim.ca
      ADMIN_ORIGIN: https://admin-dev.banksim.ca

  # Authorization Server - dev domain configuration
  auth-server:
    environment:
      ISSUER: https://auth-dev.banksim.ca
      CORS_ORIGIN: https://dev.banksim.ca,https://auth-dev.banksim.ca,https://openbanking-dev.banksim.ca,http://localhost:3005,https://ssim-dev.banksim.ca
      OPENBANKING_AUDIENCE: https://openbanking-dev.banksim.ca
      # Use parent domain for cross-subdomain passkey sharing (admin-dev + auth-dev)
      RP_ID: banksim.ca
      AUTH_ORIGIN: https://auth-dev.banksim.ca

  # Open Banking - dev domain configuration
  openbanking:
    environment:
      AUTH_SERVER_ISSUER: https://auth-dev.banksim.ca
      AUDIENCE: https://openbanking-dev.banksim.ca

  # NSIM Payment Network - dev domain configuration (multi-BSIM support)
  payment-network:
    environment:
      # NewBank BSIM connection for multi-bank payment routing
      BSIM_NEWBANK_URL: https://newbank-dev.banksim.ca
      BSIM_NEWBANK_KEY: dev-newbank-api-key

  # WSIM Backend - dev domain configuration
  wsim-backend:
    environment:
      NODE_ENV: development
      APP_URL: https://wsim-dev.banksim.ca
      FRONTEND_URL: https://wsim-dev.banksim.ca
      AUTH_SERVER_URL: https://wsim-auth-dev.banksim.ca
      CORS_ORIGINS: https://wsim-dev.banksim.ca,https://wsim-auth-dev.banksim.ca,https://ssim-dev.banksim.ca,https://dev.banksim.ca,https://regalmoose.ca,https://newbank-dev.banksim.ca
      BSIM_PROVIDERS: '[{"bsimId":"bsim","name":"Bank Simulator","issuer":"https://auth-dev.banksim.ca","apiUrl":"https://dev.banksim.ca","clientId":"wsim-wallet","clientSecret":"wsim-dev-secret"},{"bsimId":"newbank","name":"New Bank","issuer":"https://newbank-auth-dev.banksim.ca","apiUrl":"https://newbank-dev.banksim.ca","clientId":"wsim-wallet","clientSecret":"341c913561cf1a2a1bf5c60322427a9eebd19b392432adb501be35b6e6957432"}]'
      # WebAuthn - allow both frontend and auth-server popup origins
      WEBAUTHN_ORIGINS: https://wsim-dev.banksim.ca,https://wsim-auth-dev.banksim.ca
      # Mobile API JWT secret (Phase 1)
      MOBILE_JWT_SECRET: wsim-dev-mobile-jwt-secret

  # WSIM Auth Server - dev domain configuration
  wsim-auth-server:
    environment:
      NODE_ENV: development
      ISSUER: https://wsim-auth-dev.banksim.ca
      FRONTEND_URL: https://wsim-dev.banksim.ca
      CORS_ORIGINS: https://wsim-dev.banksim.ca,https://ssim-dev.banksim.ca,https://regalmoose.ca,https://dev.banksim.ca
      # WebAuthn - allow both frontend and auth-server popup origins
      WEBAUTHN_ORIGINS: https://wsim-dev.banksim.ca,https://wsim-auth-dev.banksim.ca
      # Popup/Embed origins for dev (includes BSIM for embedded enrollment)
      ALLOWED_POPUP_ORIGINS: https://ssim-dev.banksim.ca,https://regalmoose.ca,https://dev.banksim.ca
      ALLOWED_EMBED_ORIGINS: https://ssim-dev.banksim.ca,https://regalmoose.ca,https://dev.banksim.ca
      # BSIM API URL for server-to-server card fetch during embedded enrollment
      BSIM_API_URL: https://dev.banksim.ca

  # WSIM Frontend - dev domain configuration
  wsim-frontend:
    build:
      args:
        NEXT_PUBLIC_API_URL: https://wsim-dev.banksim.ca
        NEXT_PUBLIC_AUTH_URL: https://wsim-auth-dev.banksim.ca

  # SSIM - dev domain configuration
  ssim:
    environment:
      NODE_ENV: development
      OIDC_PROVIDERS: '[{"id":"bsim","name":"BSIM Bank","issuer":"https://auth-dev.banksim.ca","clientId":"ssim-client","clientSecret":"ece9c837b17bface1df34fe89d8c8e13bcf4f9e77c7a7681442952ebd9dd7015","scopes":"openid profile email fdx:accountdetailed:read fdx:transactions:read"},{"id":"newbank","name":"NewBank","issuer":"https://newbank-auth-dev.banksim.ca","clientId":"ssim-client","clientSecret":"14eb2ea2c7ede9a9594bb5faf3714a8f1da04654a73643ba10f909a631e36502","scopes":"openid profile email fdx:accountdetailed:read fdx:transactions:read"}]'
      APP_BASE_URL: https://ssim-dev.banksim.ca
      OPENBANKING_BASE_URL: https://openbanking-dev.banksim.ca
      PAYMENT_API_URL: https://payment-dev.banksim.ca
      PAYMENT_AUTH_URL: https://auth-dev.banksim.ca
      WSIM_AUTH_URL: https://wsim-auth-dev.banksim.ca
      WSIM_POPUP_URL: https://wsim-auth-dev.banksim.ca
      WSIM_API_URL: https://wsim-dev.banksim.ca/api/merchant
      # Mobile wallet payment API (Phase 3)
      WSIM_MOBILE_API_URL: https://wsim-dev.banksim.ca/api/mobile/payment
      # QR code payment URL (Phase 4)
      WSIM_QR_BASE_URL: https://wsim-dev.banksim.ca/pay
      WSIM_API_KEY: wsim_api_ssim_dev_key
      MWSIM_BROWSER_AWARE: "true"
      STORE_DOMAIN: ssim-dev.banksim.ca
      STORE_NAME: SSIM Dev Store

  # Regalmoose - dev domain configuration
  regalmoose:
    environment:
      NODE_ENV: development
      OIDC_PROVIDERS: '[{"id":"bsim","name":"BSIM Bank","issuer":"https://auth-dev.banksim.ca","clientId":"regalmoose-client","clientSecret":"010cf66b281aba82aa8a1f64724a922163caeba84f01a8daf2fa9fbfa4c5ed8a","scopes":"openid profile email fdx:accountdetailed:read fdx:transactions:read"},{"id":"newbank","name":"NewBank","issuer":"https://newbank-auth-dev.banksim.ca","clientId":"regalmoose-client","clientSecret":"fbbb499331c04581d554630daaf1f6fa549bc63b269fd3aa88007e7b6f68f4eb","scopes":"openid profile email fdx:accountdetailed:read fdx:transactions:read"}]'
      APP_BASE_URL: https://regalmoose.ca
      OPENBANKING_BASE_URL: https://openbanking-dev.banksim.ca
      PAYMENT_API_URL: https://payment-dev.banksim.ca
      PAYMENT_AUTH_URL: https://auth-dev.banksim.ca
      WSIM_AUTH_URL: https://wsim-auth-dev.banksim.ca
      WSIM_POPUP_URL: https://wsim-auth-dev.banksim.ca
      WSIM_API_URL: https://wsim-dev.banksim.ca/api/merchant
      # Mobile wallet payment API (Phase 3)
      WSIM_MOBILE_API_URL: https://wsim-dev.banksim.ca/api/mobile/payment
      # QR code payment URL (Phase 4)
      WSIM_QR_BASE_URL: https://wsim-dev.banksim.ca/pay
      WSIM_API_KEY: wsim_api_ssim_dev_key
      MWSIM_BROWSER_AWARE: "true"

  # TransferSim - dev domain configuration
  transfersim:
    environment:
      NODE_ENV: development
      # JWT validation for dev
      JWT_PUBLIC_KEY_URL: http://auth-server:3003/.well-known/jwks.json
      JWT_ISSUER: https://auth-dev.banksim.ca
      # BSIM connections for dev
      BSIM_DEFAULT_URL: http://backend:3001
      BSIM_DEFAULT_API_KEY: transfersim-dev-api-key-2024

  # Nginx - use dev configuration
  nginx:
    volumes:
      - ./nginx/nginx.dev.conf:/etc/nginx/nginx.conf:ro
      - ./certs:/etc/nginx/certs:ro
